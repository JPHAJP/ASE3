<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Robot UR5e - Flask WebApp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Socket.IO para comunicación en tiempo real -->
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        :root {
            /* Tema Claro */
            --primary-blue: #0066cc;
            --secondary-blue: #004499;
            --light-blue: #e6f3ff;
            --accent-blue: #3399ff;
            --dark-blue: #003366;
            --neon-blue: #00d4ff;
            --neon-cyan: #00ffff;
            --bg-primary: linear-gradient(135deg, #e6f3ff 0%, #ffffff 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --console-bg: #1a1a1a;
            --console-text: #00ff00;
        }

        [data-theme="dark"] {
            /* Tema Oscuro */
            --primary-blue: #0099ff;
            --secondary-blue: #0066cc;
            --light-blue: #1a2332;
            --accent-blue: var(--neon-blue);
            --dark-blue: #0d1117;
            --neon-blue: #00d4ff;
            --neon-cyan: #00ffff;
            --bg-primary: linear-gradient(135deg, #0d1117 0%, #1a2332 100%);
            --card-bg: rgba(26, 35, 50, 0.95);
            --text-primary: #f0f6fc;
            --text-secondary: #7d8590;
            --border-color: #30363d;
            --console-bg: #0d1117;
            --console-text: var(--neon-cyan);
        }

        [data-theme="dark"] body,
        [data-theme="dark"] .card-body,
        [data-theme="dark"] .form-label,
        [data-theme="dark"] h6,
        [data-theme="dark"] h5,
        [data-theme="dark"] h4,
        [data-theme="dark"] h3,
        [data-theme="dark"] h2,
        [data-theme="dark"] h1,
        [data-theme="dark"] p,
        [data-theme="dark"] span:not(.badge):not(.log-timestamp):not(.log-action):not(.log-info):not(.log-warning):not(.log-error),
        [data-theme="dark"] small,
        [data-theme="dark"] .text-primary {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .text-muted {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .navbar-brand,
        [data-theme="dark"] .navbar-text {
            color: #ffffff !important;
        }

        body {
            background: var(--bg-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            color: var(--text-primary);
            transition: all 0.3s ease;
            padding-top: 70px; /* Reducido para desktop */
        }

        .card {
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px rgba(0, 102, 204, 0.15);
            border-radius: 16px;
            background: var(--card-bg);
            backdrop-filter: blur(16px);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 212, 255, 0.2);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue));
            color: white;
            border-radius: 16px 16px 0 0 !important;
            border: none;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }

        .card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.4), transparent);
            transition: left 0.5s;
        }

        .card-header:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue));
            border: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 102, 204, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, var(--neon-blue), transparent);
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.4);
        }

        .btn-primary:hover::before {
            width: 100%;
            height: 100%;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(32, 201, 151, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #ffb300);
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 179, 0, 0.4);
        }

        .form-control, .form-select {
            border: 2px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.3s ease;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--neon-blue);
            box-shadow: 0 0 0 0.2rem rgba(0, 212, 255, 0.25);
            background: var(--card-bg);
            color: var(--text-primary);
        }

        /* Estilos específicos para tema oscuro en formularios */
        [data-theme="dark"] .form-control,
        [data-theme="dark"] .form-select {
            background: rgba(26, 35, 50, 0.8) !important;
            color: #f0f6fc !important;
            border-color: #30363d;
        }

        [data-theme="dark"] .form-control:focus,
        [data-theme="dark"] .form-select:focus {
            background: rgba(26, 35, 50, 0.9) !important;
            color: #f0f6fc !important;
            border-color: var(--neon-blue);
        }

        [data-theme="dark"] .form-control::placeholder {
            color: #7d8590 !important;
        }

        [data-theme="dark"] input[type="number"]::-webkit-outer-spin-button,
        [data-theme="dark"] input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .form-range {
            background: transparent;
        }

        .form-range::-webkit-slider-track {
            background: var(--border-color);
            border-radius: 8px;
            height: 8px;
        }

        .form-range::-webkit-slider-thumb {
            background: linear-gradient(135deg, var(--primary-blue), var(--neon-blue));
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 4px 8px rgba(0, 212, 255, 0.3);
        }

        .status-connected {
            color: var(--neon-cyan);
            text-shadow: 0 0 10px currentColor;
            font-weight: bold;
        }

        .status-disconnected {
            color: #ff4757;
            text-shadow: 0 0 10px currentColor;
            font-weight: bold;
        }

        .status-moving {
            color: #ffa502;
            text-shadow: 0 0 10px currentColor;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .coord-input {
            max-width: 80px;
        }

        .video-container {
            background: linear-gradient(135deg, var(--dark-blue), #1a2332);
            border-radius: 12px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--neon-cyan);
            border: 2px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .video-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 49%, var(--neon-blue) 50%, transparent 51%);
            opacity: 0.1;
            animation: scan 3s linear infinite;
        }

        @keyframes scan {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .simulation-container {
            background: linear-gradient(135deg, var(--dark-blue), #1a2332);
            border-radius: 12px;
            width: 100%;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--neon-cyan);
            border: 2px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .webcam-container {
            background: #000;
            border-radius: 12px;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            overflow: hidden;
            border: 2px solid var(--border-color);
        }

        .webcam-stream {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }

        .simulation-container::after {
            content: '';
            position: absolute;
            width: 100px;
            height: 100px;
            border: 2px solid var(--neon-blue);
            border-radius: 50%;
            animation: rotate 4s linear infinite;
            opacity: 0.3;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .console-log {
            background: var(--console-bg);
            color: var(--console-text);
            border-radius: 12px;
            height: 250px;
            overflow-y: auto;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 13px;
            padding: 15px;
            white-space: pre-wrap;
            border: 2px solid var(--border-color);
            position: relative;
        }

        .console-log::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-cyan), var(--neon-blue));
            animation: console-glow 2s ease-in-out infinite;
        }

        @keyframes console-glow {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .console-log::-webkit-scrollbar {
            width: 12px;
        }

        .console-log::-webkit-scrollbar-track {
            background: rgba(26, 26, 26, 0.5);
            border-radius: 6px;
        }

        .console-log::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary-blue), var(--neon-blue));
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .console-log::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--neon-blue), var(--neon-cyan));
        }

        .toggle-switch {
            position: relative;
            width: 70px;
            height: 35px;
            background: var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid var(--primary-blue);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active {
            background: linear-gradient(135deg, var(--primary-blue), var(--neon-blue));
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 29px;
            height: 29px;
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(35px);
            background: linear-gradient(135deg, var(--neon-cyan), #ffffff);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.7);
        }

        .program-item {
            background: linear-gradient(135deg, var(--light-blue), var(--card-bg));
            border: 2px solid var(--primary-blue);
            border-radius: 12px;
            padding: 15px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            color: var(--text-primary);
        }

        /* Estilos específicos para program-item en tema oscuro */
        [data-theme="dark"] .program-item {
            background: linear-gradient(135deg, rgba(26, 35, 50, 0.6), rgba(26, 35, 50, 0.8));
            color: #f0f6fc !important;
            border-color: var(--neon-blue);
        }

        [data-theme="dark"] .program-item i {
            color: var(--neon-cyan) !important;
        }

        .program-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .program-item:hover {
            background: linear-gradient(135deg, var(--accent-blue), var(--primary-blue));
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.4);
            border-color: var(--neon-blue);
        }

        .program-item:hover::before {
            left: 100%;
        }

        /* Nuevo diseño del navbar desde cero */
        .navbar {
            background: linear-gradient(135deg, var(--dark-blue), var(--primary-blue)) !important;
            border-bottom: 2px solid var(--neon-blue);
            box-shadow: 0 2px 20px rgba(0, 212, 255, 0.2);
            padding: 0.75rem 1rem;
            min-height: 60px;
        }

        .navbar-brand {
            color: #ffffff !important;
            font-size: 1.25rem;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .navbar-brand:hover {
            color: var(--neon-cyan) !important;
            text-shadow: 0 0 15px var(--neon-cyan);
        }

        .navbar-brand .bi {
            font-size: 1.5rem;
            color: var(--neon-cyan) !important;
            animation: pulse 2s infinite;
        }

        .navbar-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .system-status {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #ffffff;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 12px;
            border-radius: 20px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .system-status .bi {
            color: var(--neon-cyan) !important;
            animation: rotate 3s linear infinite;
        }

        .theme-toggle-btn {
            background: rgba(255, 255, 255, 0.1) !important;
            border: 2px solid var(--neon-blue) !important;
            color: #ffffff !important;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .theme-toggle-btn:hover {
            background: var(--neon-blue) !important;
            color: #000000 !important;
            transform: rotate(180deg);
            box-shadow: 0 0 20px var(--neon-cyan);
        }

        .theme-toggle-btn .bi {
            font-size: 1.2rem;
        }

        /* Animaciones para el navbar */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Responsive del navbar */
        @media (max-width: 768px) {
            .navbar {
                padding: 0.5rem 0.75rem;
                min-height: 55px;
            }
            
            .navbar-brand {
                font-size: 1rem;
            }
            
            .system-status {
                font-size: 0.8rem;
                padding: 3px 8px;
            }
            
            .theme-toggle-btn {
                width: 40px;
                height: 40px;
            }
            
            body {
                padding-top: 65px; /* Menos padding para tablets */
            }
        }

        @media (max-width: 576px) {
            .navbar-controls {
                gap: 8px;
            }
            
            .system-status span.status-text {
                display: none;
            }
            
            body {
                padding-top: 60px; /* Aún menos padding para móviles */
            }
        }

        @media (min-width: 992px) {
            body {
                padding-top: 70px; /* Padding apropiado para desktop */
            }
        }

        .position-display {
            background: var(--light-blue);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            border: 2px solid var(--border-color);
            position: relative;
            color: var(--text-primary);
        }

        /* Estilos específicos para position-display en tema oscuro */
        [data-theme="dark"] .position-display {
            background: rgba(26, 35, 50, 0.6);
            border-color: #30363d;
        }

        [data-theme="dark"] .position-display h6,
        [data-theme="dark"] .position-display small {
            color: #f0f6fc !important;
        }

        /* Asegurar que todos los badges se vean bien */
        [data-theme="dark"] .badge {
            color: #ffffff !important;
        }

        /* Botones en tema oscuro */
        [data-theme="dark"] .btn-outline-primary {
            color: var(--neon-blue) !important;
            border-color: var(--neon-blue) !important;
        }

        [data-theme="dark"] .btn-outline-primary:hover {
            background: var(--neon-blue) !important;
            color: #000000 !important;
        }

        [data-theme="dark"] .btn-outline-light {
            color: #f0f6fc !important;
            border-color: #7d8590 !important;
        }

        [data-theme="dark"] .btn-outline-light:hover {
            background: #f0f6fc !important;
            color: #0d1117 !important;
        }

        .position-display::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            background: linear-gradient(45deg, var(--neon-blue), transparent, var(--neon-cyan), transparent);
            border-radius: 12px;
            z-index: -1;
            animation: border-glow 3s linear infinite;
        }

        @keyframes border-glow {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 2px 0;
            border-left: 3px solid transparent;
            padding-left: 8px;
            transition: all 0.3s ease;
        }

        .log-entry:hover {
            background: rgba(0, 212, 255, 0.1);
            border-left-color: var(--neon-blue);
        }

        .log-timestamp {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .log-action {
            color: var(--neon-cyan);
            text-shadow: 0 0 5px currentColor;
            font-weight: bold;
        }

        .log-info {
            color: var(--accent-blue);
            text-shadow: 0 0 3px currentColor;
        }

        .log-warning {
            color: #ffa502;
            text-shadow: 0 0 5px currentColor;
            font-weight: bold;
        }

        .log-error {
            color: #ff4757;
            text-shadow: 0 0 8px currentColor;
            font-weight: bold;
        }

        /* Botón para cambiar tema */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--card-bg);
            border: 2px solid var(--primary-blue);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .theme-toggle:hover {
            transform: rotate(180deg);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.5);
        }

        /* Responsive mejoras */
        @media (max-width: 768px) {
            .coord-input {
                max-width: 100%;
                margin-bottom: 5px;
            }
            
            .card {
                margin-bottom: 1rem;
            }
            
            .simulation-container,
            .video-container {
                height: 150px;
            }
            
            .webcam-container {
                height: 150px !important;
            }
            
            /* Stack las columnas en dispositivos móviles */
            .col-lg-6 {
                margin-bottom: 2rem;
            }
            
            .console-log {
                height: 200px !important;
            }
        }

        @media (max-width: 576px) {
            .coord-input {
                font-size: 12px;
            }
            
            .btn-sm {
                font-size: 10px;
                padding: 0.1rem 0.3rem;
            }
            
            .console-log {
                height: 150px !important;
                font-size: 10px;
            }
            
            .webcam-container {
                height: 120px !important;
            }
        }

        /* Mejoras en el diseño de las tarjetas */
        .card-header {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }

        /* Espaciado mejorado para el layout de dos columnas */
        .container-fluid {
            padding-left: 10px;
            padding-right: 10px;
        }

        /* Tarjetas más compactas */
        .card {
            margin-bottom: 0.75rem !important;
        }

        .card-body {
            padding: 0.75rem;
        }

        /* Mejora del contraste visual */
        .mb-3 {
            margin-bottom: 1rem !important;
        }

        /* Optimización de altura de consolas */
        .console-log {
            height: 280px;
            font-size: 12px;
        }

        /* Altura de contenedores multimedia */
        .webcam-container, .simulation-container {
            min-height: 180px;
        }

        /* Botones más compactos para ahorrar espacio */
        .btn-sm {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }

        /* Labels más pequeños para controles */
        .form-label {
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        /* Program items más compactos */
        .program-item {
            padding: 10px;
            margin: 4px 0;
            font-size: 0.9rem;
        }

        /* Optimización del layout general para mantener todo visible */
        @media (min-width: 992px) {
            .col-lg-6 {
                max-height: calc(100vh - 100px);
                overflow-y: auto;
                padding-right: 5px;
            }
            
            .container-fluid {
                max-height: none;
                overflow: visible;
                padding-top: 5px;
            }
        }

        /* Reglas generales para tema oscuro - capturar cualquier texto que se escape */
        [data-theme="dark"] * {
            border-color: #30363d;
        }

        [data-theme="dark"] .card-body > *,
        [data-theme="dark"] .card-body label,
        [data-theme="dark"] .card-body div,
        [data-theme="dark"] .row > div > *:not(.badge):not(.btn) {
            color: #f0f6fc !important;
        }

        /* Asegurar que los iconos se vean bien */
        [data-theme="dark"] .bi {
            color: var(--neon-cyan);
        }

        [data-theme="dark"] .card-header .bi {
            color: #ffffff !important;
        }

        /* Los sliders en tema oscuro */
        [data-theme="dark"] .form-range::-webkit-slider-track {
            background: #30363d !important;
        }

        [data-theme="dark"] .form-range::-webkit-slider-thumb {
            background: linear-gradient(135deg, var(--neon-blue), var(--neon-cyan)) !important;
        }

        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-blue);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Nuevo navbar completamente rediseñado -->
    <nav class="navbar navbar-dark fixed-top">
        <div class="container-fluid">
            <!-- Brand/Logo -->
            <div class="navbar-brand">
                <i class="bi bi-robot"></i>
                <span>Control Robot UR5e Industrial</span>
            </div>
            
            <!-- Controles del navbar -->
            <div class="navbar-controls">
                <!-- Estado del sistema -->
                <div class="system-status">
                    <i class="bi bi-wifi"></i>
                    <span class="status-text">Sistema Activo</span>
                </div>
                
                <!-- Botón de cambio de tema -->
                <button class="btn theme-toggle-btn" onclick="toggleTheme()" id="themeToggle" title="Cambiar tema">
                    <i class="bi bi-moon-fill" id="themeIcon"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- COLUMNA IZQUIERDA - TODOS LOS CONTROLES -->
            <div class="col-lg-6 mb-4">
                <!-- Control de Posición del Robot -->
                <div class="card mb-3">
                    <div class="card-header">
                        <i class="bi bi-crosshair"></i> Control de Posición del Robot
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6 class="text-primary">Coordenadas (mm y grados)</h6>
                            <div class="row g-2">
                                <div class="col-2">
                                    <label class="form-label">X (mm)</label>
                                    <input type="number" class="form-control coord-input" id="coordX" step="1" value="300">
                                </div>
                                <div class="col-2">
                                    <label class="form-label">Y (mm)</label>
                                    <input type="number" class="form-control coord-input" id="coordY" step="1" value="-200">
                                </div>
                                <div class="col-2">
                                    <label class="form-label">Z (mm)</label>
                                    <input type="number" class="form-control coord-input" id="coordZ" step="1" value="500">
                                </div>
                                <div class="col-2">
                                    <label class="form-label">RX (°)</label>
                                    <input type="number" class="form-control coord-input" id="coordRX" step="1" value="0">
                                </div>
                                <div class="col-2">
                                    <label class="form-label">RY (°)</label>
                                    <input type="number" class="form-control coord-input" id="coordRY" step="1" value="0">
                                </div>
                                <div class="col-2">
                                    <label class="form-label">RZ (°)</label>
                                    <input type="number" class="form-control coord-input" id="coordRZ" step="1" value="0">
                                </div>
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col-8">
                                    <button class="btn btn-primary w-100" onclick="moveToCoordinates()" id="moveBtn">
                                        <i class="bi bi-arrow-right-circle"></i> Mover Robot a Posición
                                    </button>
                                </div>
                                <div class="col-4">
                                    <button class="btn btn-success w-100" onclick="goHome()">
                                        <i class="bi bi-house-door"></i> Home
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Gestión de Posiciones -->
                        <div class="mb-3">
                            <h6 class="text-primary">Gestión de Posiciones</h6>
                            <div class="row g-2">
                                <div class="col-4">
                                    <button class="btn btn-outline-primary w-100" onclick="listPositions()">
                                        <i class="bi bi-list"></i> Ver
                                    </button>
                                </div>
                                <div class="col-4">
                                    <input type="text" class="form-control" id="positionName" placeholder="Nombre posición">
                                </div>
                                <div class="col-2">
                                    <button class="btn btn-success w-100" onclick="savePosition()">
                                        <i class="bi bi-save"></i>
                                    </button>
                                </div>
                                <div class="col-2">
                                    <button class="btn btn-warning w-100" onclick="loadPosition()">
                                        <i class="bi bi-upload"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Modo de Control -->
                        <div>
                            <h6 class="text-primary">Modo de Control</h6>
                            <div class="d-flex align-items-center justify-content-center">
                                <span class="me-3">Coordenadas</span>
                                <div class="toggle-switch" id="controlToggle" onclick="toggleControlMode()">
                                    <div class="toggle-slider"></div>
                                </div>
                                <span class="ms-3">Xbox Controller</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Control de Gripper uSENSEGRIP -->
                <div class="card mb-3">
                    <div class="card-header">
                        <i class="bi bi-wrench-adjustable"></i> Control de Gripper uSENSEGRIP
                    </div>
                    <div class="card-body">
                        <!-- Control Básico -->
                        <div class="card mt-2">
                            <div class="card-header py-2">
                                <small><i class="bi bi-sliders"></i> Control Básico</small>
                            </div>
                            <div class="card-body p-2">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label class="form-label small">Fuerza (N)</label>
                                        <input type="range" class="form-range" id="gripperForce" min="0" max="50" value="5" step="0.1">
                                        <span id="forceValue">5.0</span> N
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Distancia (mm)</label>
                                        <input type="range" class="form-range" id="gripperDistance" min="0" max="100" value="0" step="0.1">
                                        <span id="distanceValue">0.0</span> mm
                                    </div>
                                </div>
                                <div class="row g-1 mt-2">
                                    <div class="col-3">
                                        <button class="btn btn-success btn-sm w-100" onclick="openGripper()">
                                            <i class="bi bi-arrows-expand"></i> Abrir
                                        </button>
                                    </div>
                                    <div class="col-3">
                                        <button class="btn btn-warning btn-sm w-100" onclick="closeGripper()">
                                            <i class="bi bi-arrows-collapse"></i> Cerrar
                                        </button>
                                    </div>
                                    <div class="col-3">
                                        <button class="btn btn-info btn-sm w-100" onclick="homeGripper()">
                                            <i class="bi bi-house"></i> Home
                                        </button>
                                    </div>
                                    <div class="col-3">
                                        <button class="btn btn-primary btn-sm w-100" onclick="sendGripperBasic()">
                                            <i class="bi bi-send"></i> Enviar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Comandos Específicos Compactos -->
                        <div class="card mt-2">
                            <div class="card-header py-1">
                                <small><i class="bi bi-terminal"></i> Comandos uSENSEGRIP</small>
                            </div>
                            <div class="card-body p-2">
                                <!-- Fila 1: HELP & CONFIG -->
                                <div class="row g-1 mb-1">
                                    <div class="col-2">
                                        <button class="btn btn-info btn-sm w-100" onclick="sendGripperCmd('HELP')" title="Mostrar ayuda">
                                            HELP
                                        </button>
                                    </div>
                                    <div class="col-3">
                                        <button class="btn btn-secondary btn-sm w-100" onclick="sendGripperCmd('CONFIG STALL STINFO')" title="Toggle telemetría">
                                            STALL
                                        </button>
                                    </div>
                                    <div class="col-3">
                                        <button class="btn btn-secondary btn-sm w-100" onclick="sendGripperCmd('CONFIG HOMING ONBOOT')" title="Auto homing">
                                            AUTO HOME
                                        </button>
                                    </div>
                                    <div class="col-2">
                                        <button class="btn btn-warning btn-sm w-100" onclick="sendGripperCmd('CONFIG SAVE')" title="Guardar config">
                                            SAVE
                                        </button>
                                    </div>
                                    <div class="col-2">
                                        <button class="btn btn-success btn-sm w-100" onclick="sendGripperCmd('MOVE GRIP HOME')" title="Homing">
                                            HOME
                                        </button>
                                    </div>
                                </div>

                                <!-- Fila 2: MOVE -->
                                <div class="row g-1 mb-1">
                                    <div class="col-4">
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="stepInput" placeholder="Pasos" title="Pasos">
                                            <button class="btn btn-outline-primary btn-sm" onclick="moveSteps()" title="Mover pasos">
                                                STEPS
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="distInput" placeholder="mm" step="0.1">
                                            <button class="btn btn-outline-success btn-sm" onclick="moveDist()" title="Distancia mm">
                                                DIST
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="forceInput" placeholder="N" step="0.1">
                                            <button class="btn btn-outline-warning btn-sm" onclick="setTargetForce()" title="Fuerza objetivo">
                                                FORCE
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Fila 3: GET INFO -->
                                <div class="row g-1 mb-1">
                                    <div class="col-2">
                                        <button class="btn btn-info btn-sm w-100" onclick="sendGripperCmd('GET GRIP STpos')" title="Posición stepper">
                                            ST pos
                                        </button>
                                    </div>
                                    <div class="col-2">
                                        <button class="btn btn-info btn-sm w-100" onclick="sendGripperCmd('GET GRIP MMpos')" title="Posición mm">
                                            MM pos
                                        </button>
                                    </div>
                                    <div class="col-2">
                                        <button class="btn btn-info btn-sm w-100" onclick="sendGripperCmd('GET GRIP ForceNf')" title="Fuerza N">
                                            Force N
                                        </button>
                                    </div>
                                    <div class="col-3">
                                        <button class="btn btn-warning btn-sm w-100" onclick="sendGripperCmd('DO FORCE CAL')" title="Calibrar fuerza">
                                            CAL
                                        </button>
                                    </div>
                                    <div class="col-3">
                                        <button class="btn btn-danger btn-sm w-100" onclick="sendGripperCmd('DO GRIP REBOOT')" title="Reboot">
                                            REBOOT
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Terminal RAW -->
                        <div class="card mt-2">
                            <div class="card-header py-1">
                                <small><i class="bi bi-keyboard"></i> Terminal RAW</small>
                            </div>
                            <div class="card-body p-2">
                                <div class="input-group">
                                    <input type="text" class="form-control form-control-sm" id="manualCommand" 
                                           placeholder="Comando manual" 
                                           onkeypress="handleCommandKeyPress(event)"
                                           autocomplete="off">
                                    <button class="btn btn-primary btn-sm" onclick="sendManualCommand()">
                                        <i class="bi bi-send"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rutinas Preestablecidas -->
                <div class="card mb-3">
                    <div class="card-header">
                        <i class="bi bi-play-circle"></i> Rutinas Preestablecidas
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="program-item" onclick="runProgram(1)">
                                    <i class="bi bi-play-circle"></i> Rutina de Calibración
                                </div>
                                <div class="program-item" onclick="runProgram(2)">
                                    <i class="bi bi-arrow-repeat"></i> Ciclo de Prueba
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="program-item" onclick="runProgram(3)">
                                    <i class="bi bi-house"></i> Posición Inicial
                                </div>
                                <div class="program-item" onclick="runProgram(4)">
                                    <i class="bi bi-shield-check"></i> Rutina Seguridad
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUMNA DERECHA - ESTADOS Y CONSOLAS -->
            <div class="col-lg-6 mb-4">
                <!-- Estado del Sistema -->
                <div class="card mb-3">
                    <div class="card-header">
                        <i class="bi bi-info-circle"></i> Estado del Sistema
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-4">
                                <h6>Robot UR5e</h6>
                                <p class="mb-1">Estado: <span id="robotStatus" class="status-disconnected">Desconectado</span></p>
                                <p class="mb-0">IP: {{ app_state.get('robot_ip', 'N/A') }}</p>
                            </div>
                            <div class="col-4">
                                <h6>Xbox Controller</h6>
                                <p class="mb-1">Conexión: <span id="xboxStatus" class="status-disconnected">Desconectado</span></p>
                                <p class="mb-0">Modo: <span id="controlMode">Coordenadas</span></p>
                            </div>
                            <div class="col-4">
                                <h6>Gripper Serie</h6>
                                <p class="mb-1">Estado: <span id="serialStatus" class="status-disconnected">Desconectado</span></p>
                                <p class="mb-0">Puerto: <span id="serialPort">Auto-detect</span></p>
                            </div>
                        </div>
                        
                        <div class="position-display mt-3">
                            <h6>Posición Actual del Robot</h6>
                            <div class="row g-2">
                                <div class="col-4">
                                    <small>X: <span id="currentX">0.0</span> mm</small>
                                </div>
                                <div class="col-4">
                                    <small>Y: <span id="currentY">0.0</span> mm</small>
                                </div>
                                <div class="col-4">
                                    <small>Z: <span id="currentZ">0.0</span> mm</small>
                                </div>
                                <div class="col-4">
                                    <small>RX: <span id="currentRX">0.0</span>°</small>
                                </div>
                                <div class="col-4">
                                    <small>RY: <span id="currentRY">0.0</span>°</small>
                                </div>
                                <div class="col-4">
                                    <small>RZ: <span id="currentRZ">0.0</span>°</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cámara Web y URRTDE -->
                <div class="row mb-3">
                    <!-- Cámara Web -->
                    <div class="col-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-camera-video"></i> Cámara Web</span>
                                <div>
                                    <button class="btn btn-sm btn-outline-light me-1" onclick="startWebcam()">
                                        <i class="bi bi-play"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-light me-1" onclick="stopWebcam()">
                                        <i class="bi bi-stop"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-light" onclick="capturePhoto()">
                                        <i class="bi bi-camera"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-2">
                                <div class="webcam-container" id="webcamContainer" style="height: 200px;">
                                    <div class="text-center" id="webcamPlaceholder">
                                        <i class="bi bi-camera-video-off" style="font-size: 1.5rem;"></i>
                                        <p class="mt-2 mb-0 small">Cámara Desconectada</p>
                                        <small>Presiona <i class="bi bi-play"></i> para iniciar</small>
                                    </div>
                                    <img id="webcamStream" class="webcam-stream" style="display: none; width: 100%; height: auto;" alt="Stream de la webcam">
                                </div>
                                <div class="mt-1">
                                    <span class="badge bg-secondary" id="webcamStatus">Desconectada</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Estado URRTDE -->
                    <div class="col-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-info-circle"></i> URRTDE
                            </div>
                            <div class="card-body p-2">
                                <div class="simulation-container" id="urrtdeContainer" style="height: 200px;">
                                    <div class="text-center" id="urrtdePlaceholder">
                                        <i class="bi bi-robot" style="font-size: 1.5rem;"></i>
                                        <p class="mt-2 mb-0 small">URRTDE</p>
                                        <small>Desconectado</small>
                                        <br><br>
                                        <div class="badge bg-warning">Robot No Disponible</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Consolas -->
                <div class="row">
                    <!-- Consola del Gripper -->
                    <div class="col-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-wrench-adjustable"></i> Gripper</span>
                                <button class="btn btn-sm btn-outline-light" onclick="clearGripperConsole()">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div id="gripperConsole" class="console-log" style="height: 300px;">
                                    <span class="text-info">🔍 Monitor del Gripper - Respuestas en tiempo real</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Consola de Sistema -->
                    <div class="col-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-terminal"></i> Sistema</span>
                                <button class="btn btn-sm btn-outline-light" onclick="clearLog()">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div id="consoleLog" class="console-log" style="height: 300px;">
                                    <!-- Los logs se cargarán aquí dinámicamente -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let socket;
        let isXboxMode = false;
        let savedPositions = {};
        let currentPosition = { x: 300, y: -200, z: 500, rx: 0, ry: 0, rz: 0 };
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            initializeWebSocket();
            updateSliderValues();
            updateCurrentPositionDisplay();
            initializeGripperInterface();
            
            // Intentar conectar gripper automáticamente después de un breve delay
            setTimeout(function() {
                tryAutoConnectGripper();
            }, 2000);
            
            addLogMessage('Sistema web inicializado', 'info');
        });

        // Intentar conexión automática del gripper
        function tryAutoConnectGripper() {
            addGripperMessage('Intentando conexión automática...', 'info');
            
            fetch('/api/gripper/connect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addGripperMessage('✅ Gripper conectado automáticamente', 'response', true);
                    updateGripperStatus({ connected: true, port: data.port });
                } else {
                    addGripperMessage(`❌ Error en conexión automática: ${data.error}`, 'error', true);
                    updateGripperStatus({ connected: false });
                }
            })
            .catch(error => {
                addGripperMessage(`❌ Error en conexión automática: ${error}`, 'error');
                updateGripperStatus({ connected: false });
            });
        }

        // Inicializar interfaz del gripper
        function initializeGripperInterface() {
            // Cargar historial de comandos del localStorage
            const savedHistory = localStorage.getItem('gripperCommandHistory');
            if (savedHistory) {
                try {
                    commandHistory = JSON.parse(savedHistory);
                    updateCommandHistory();
                } catch (e) {
                    console.warn('Error cargando historial de comandos:', e);
                }
            }
            
            // Validación en tiempo real del input manual
            const manualInput = document.getElementById('manualCommand');
            manualInput.addEventListener('input', validateCommand);
            
            addGripperMessage('Interfaz del Gripper uSENSEGRIP lista', 'info');
        }

        // Validar comando en tiempo real
        function validateCommand() {
            const input = document.getElementById('manualCommand');
            const command = input.value.trim().toUpperCase();
            
            // Lista de comandos válidos
            const validCommands = [
                'HELP',
                'CONFIG STALL STINFO',
                'CONFIG STALL DIAG', 
                'CONFIG HOMING ONBOOT',
                'CONFIG SET MOTORMODE',
                'CONFIG SAVE',
                'MOVE GRIP HOME',
                'MOVE GRIP STEPS',
                'MOVE GRIP DIST',
                'MOVE GRIP TFORCE',
                'GET GRIP USTEP',
                'GET GRIP STPOS',
                'GET GRIP MMPOS',
                'GET GRIP FORCENF',
                'GET GRIP FORCEGF',
                'GET GRIP DISTOBJ',
                'DO FORCE CAL',
                'DO GRIP REBOOT'
            ];
            
            let isValid = false;
            
            // Verificar si el comando es válido
            for (let validCmd of validCommands) {
                if (command === validCmd || command.startsWith(validCmd + ' ')) {
                    isValid = true;
                    break;
                }
            }
            
            // Aplicar estilo visual
            if (command === '') {
                input.style.borderColor = '';
                input.style.backgroundColor = '';
            } else if (isValid) {
                input.style.borderColor = '#28a745';
                input.style.backgroundColor = '#f8fff9';
            } else {
                input.style.borderColor = '#dc3545';
                input.style.backgroundColor = '#fff8f8';
            }
            
            // Habilitar/deshabilitar botón
            const sendBtn = document.getElementById('sendManualBtn');
            sendBtn.disabled = !isValid && command !== '';
        }

        // Inicializar WebSocket
        function initializeWebSocket() {
            socket = io();
            
            socket.on('connect', function() {
                addLogMessage('Conexión WebSocket establecida', 'info');
                updateConnectionStatus(true);
                socket.emit('request_status');
            });
            
            socket.on('disconnect', function() {
                addLogMessage('Conexión WebSocket perdida', 'warning');
                updateConnectionStatus(false);
            });
            
            socket.on('status_update', function(data) {
                updateSystemStatus(data);
            });
            
            socket.on('robot_status_update', function(data) {
                updateRobotStatus(data);
            });
            
            socket.on('new_log', function(logEntry) {
                displayLogEntry(logEntry);
            });
            
            // Eventos específicos del gripper - MONITOR CONTINUO SIN ERRORES POR FALTA DE RESPUESTA
            socket.on('gripper_response', function(data) {
                // Solo procesar si efectivamente hay una respuesta
                if (data.response) {
                    const lines = data.response.split('\n');
                    lines.forEach(line => {
                        line = line.trim();
                        if (line) {
                            let messageType = 'response';
                            if (data.is_error) {
                                messageType = 'error';
                            } else if (line.includes('Force') || line.includes('Position') || line.includes('mm') || line.includes('steps')) {
                                messageType = 'info';
                            }
                            addGripperMessage(line, messageType, true);
                        }
                    });
                }
                // NO mostrar errores si no hay respuesta - el dispositivo puede no responder y está bien
            });
            
            // Evento para respuestas en tiempo real - SOLO PROCESAR SI HAY DATOS
            socket.on('gripper_live_response', function(data) {
                if (data.response) {
                    const lines = data.response.split('\n');
                    lines.forEach(line => {
                        line = line.trim();
                        if (line) {
                            addGripperMessage(line, 'raw_response', true);
                        }
                    });
                }
            });

            // Streaming continuo - SOLO MOSTRAR SI HAY CHUNK DE DATOS
            socket.on('gripper_stream', function(data) {
                if (data.chunk) {
                    const lines = data.chunk.split('\n');
                    lines.forEach(line => {
                        line = line.trim();
                        if (line) {
                            addGripperMessage(line, 'stream', true);
                        }
                    });
                }
            });

            // Fin de respuesta múltiple - OPCIONAL
            socket.on('gripper_response_complete', function(data) {
                // Solo mostrar si realmente hubo múltiples líneas
                if (data.total_lines && data.total_lines > 5) {
                    addGripperMessage(`✓ ${data.total_lines} líneas recibidas`, 'info', true);
                }
            });
            
            socket.on('gripper_status', function(data) {
                updateGripperStatus(data);
            });
        }

        // Actualizar estado de conexión
        function updateConnectionStatus(connected) {
            const icon = document.getElementById('connectionIcon');
            const status = document.getElementById('connectionStatus');
            
            if (connected) {
                icon.className = 'bi bi-wifi';
                status.textContent = 'Conectado';
            } else {
                icon.className = 'bi bi-wifi-off';
                status.textContent = 'Desconectado';
            }
        }

        // Actualizar estado del sistema
        function updateSystemStatus(data) {
            // Actualizar estado del robot
            const robotStatus = document.getElementById('robotStatus');
            if (data.robot_connected) {
                robotStatus.textContent = 'Conectado';
                robotStatus.className = 'status-connected';
            } else {
                robotStatus.textContent = 'Desconectado';
                robotStatus.className = 'status-disconnected';
            }
            
            // Actualizar estado Xbox
            const xboxStatus = document.getElementById('xboxStatus');
            if (data.xbox_connected) {
                xboxStatus.textContent = 'Conectado';
                xboxStatus.className = 'status-connected';
            } else {
                xboxStatus.textContent = 'Desconectado';
                xboxStatus.className = 'status-disconnected';
            }
            
            // Actualizar estado Serie
            const serialStatus = document.getElementById('serialStatus');
            const gripperBadge = document.getElementById('gripperConnectionBadge');
            
            if (data.serial_connected) {
                serialStatus.textContent = 'Conectado';
                serialStatus.className = 'status-connected';
                gripperBadge.textContent = 'Conectado';
                gripperBadge.className = 'badge bg-success me-2';
            } else {
                serialStatus.textContent = 'Desconectado';
                serialStatus.className = 'status-disconnected';
                gripperBadge.textContent = 'Desconectado';
                gripperBadge.className = 'badge bg-danger me-2';
            }
            
            // Actualizar puerto serie si está disponible
            if (data.serial_port) {
                document.getElementById('serialPort').textContent = data.serial_port;
            }
            
            // Actualizar posición actual
            if (data.current_position) {
                currentPosition = {
                    x: data.current_position[0] || 300,
                    y: data.current_position[1] || -200,
                    z: data.current_position[2] || 500,
                    rx: data.current_position[3] || 0,
                    ry: data.current_position[4] || 0,
                    rz: data.current_position[5] || 0
                };
                updateCurrentPositionDisplay();
            }
            
            // Actualizar posiciones guardadas
            if (data.saved_positions) {
                savedPositions = data.saved_positions;
            }
        }

        // Actualizar estado del robot
        function updateRobotStatus(data) {
            if (data.position) {
                currentPosition = {
                    x: data.position[0] || 300,
                    y: data.position[1] || -200,
                    z: data.position[2] || 500,
                    rx: data.position[3] || 0,
                    ry: data.position[4] || 0,
                    rz: data.position[5] || 0
                };
                updateCurrentPositionDisplay();
            }
        }

        // Actualizar display de posición actual
        function updateCurrentPositionDisplay() {
            document.getElementById('currentX').textContent = currentPosition.x.toFixed(1);
            document.getElementById('currentY').textContent = currentPosition.y.toFixed(1);
            document.getElementById('currentZ').textContent = currentPosition.z.toFixed(1);
            document.getElementById('currentRX').textContent = currentPosition.rx.toFixed(1);
            document.getElementById('currentRY').textContent = currentPosition.ry.toFixed(1);
            document.getElementById('currentRZ').textContent = currentPosition.rz.toFixed(1);
        }

        // Agregar mensaje al log
        function addLogMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            displayLogEntry({
                timestamp: timestamp,
                message: message,
                type: type
            });
        }

        // Mostrar entrada de log
        function displayLogEntry(logEntry) {
            const console = document.getElementById('consoleLog');
            const logDiv = document.createElement('div');
            logDiv.className = 'log-entry';
            
            let className = 'log-info';
            switch(logEntry.type) {
                case 'action': className = 'log-action'; break;
                case 'warning': className = 'log-warning'; break;
                case 'error': className = 'log-error'; break;
            }
            
            logDiv.innerHTML = `<span class="log-timestamp">[${logEntry.timestamp}]</span> <span class="${className}">${logEntry.message}</span>`;
            console.appendChild(logDiv);
            console.scrollTop = console.scrollHeight;
        }

        // Limpiar log
        function clearLog() {
            fetch('/api/logs/clear', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('consoleLog').innerHTML = '';
                }
            });
        }

        // Variables globales para gripper
        let commandHistory = [];
        let historyIndex = -1;

        // Actualizar valores de sliders
        function updateSliderValues() {
            const forceSlider = document.getElementById('gripperForce');
            const distanceSlider = document.getElementById('gripperDistance');
            
            forceSlider.addEventListener('input', function() {
                document.getElementById('forceValue').textContent = parseFloat(this.value).toFixed(1);
            });

            distanceSlider.addEventListener('input', function() {
                document.getElementById('distanceValue').textContent = parseFloat(this.value).toFixed(1);
            });
        }

        // Mover robot a coordenadas
        function moveToCoordinates() {
            const coords = {
                x: parseFloat(document.getElementById('coordX').value) || 0,
                y: parseFloat(document.getElementById('coordY').value) || 0,
                z: parseFloat(document.getElementById('coordZ').value) || 0,
                rx: parseFloat(document.getElementById('coordRX').value) || 0,
                ry: parseFloat(document.getElementById('coordRY').value) || 0,
                rz: parseFloat(document.getElementById('coordRZ').value) || 0
            };

            const button = document.getElementById('moveBtn');
            button.disabled = true;
            button.innerHTML = '<span class="loading-spinner"></span>Moviendo...';

            fetch('/api/robot/move', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(coords)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLogMessage(`Movimiento exitoso a X:${coords.x}, Y:${coords.y}, Z:${coords.z}`, 'action');
                } else {
                    addLogMessage(`Error en movimiento: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                addLogMessage(`Error de conexión: ${error}`, 'error');
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-arrow-right-circle"></i> Mover Robot';
            });
        }



        // Ir a Home
        function goHome() {
            fetch('/api/robot/home', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLogMessage('Robot enviado a posición HOME', 'action');
                } else {
                    addLogMessage(`Error al ir a HOME: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                addLogMessage(`Error: ${error}`, 'error');
            });
        }

        // Guardar posición
        function savePosition() {
            const name = document.getElementById('positionName').value;
            if (!name) {
                addLogMessage('Error: Nombre de posición requerido', 'error');
                return;
            }

            fetch('/api/positions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: name })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLogMessage(`Posición "${name}" guardada exitosamente`, 'action');
                    savedPositions[name] = data.position;
                } else {
                    addLogMessage(`Error guardando posición: ${data.error}`, 'error');
                }
            });
        }

        // Cargar posición
        function loadPosition() {
            const name = document.getElementById('positionName').value;
            if (!name) {
                addLogMessage('Error: Especifica un nombre de posición', 'error');
                return;
            }

            if (savedPositions[name]) {
                const pos = savedPositions[name].coordinates;
                document.getElementById('coordX').value = pos[0];
                document.getElementById('coordY').value = pos[1];
                document.getElementById('coordZ').value = pos[2];
                document.getElementById('coordRX').value = pos[3];
                document.getElementById('coordRY').value = pos[4];
                document.getElementById('coordRZ').value = pos[5];
                addLogMessage(`Posición "${name}" cargada`, 'action');
            } else {
                addLogMessage(`Posición "${name}" no encontrada`, 'error');
            }
        }

        // Listar posiciones
        function listPositions() {
            fetch('/api/positions')
            .then(response => response.json())
            .then(positions => {
                const names = Object.keys(positions);
                if (names.length > 0) {
                    const positionList = names.map(name => {
                        const coords = positions[name].coordinates;
                        return `${name}: [${coords.join(', ')}]`;
                    }).join('\n');
                    addLogMessage(`Posiciones guardadas:\n${positionList}`, 'info');
                } else {
                    addLogMessage('No hay posiciones guardadas', 'info');
                }
                savedPositions = positions;
            });
        }

        // ==================== FUNCIONES DEL GRIPPER uSENSE ====================

        // Agregar mensaje a la consola del gripper
        function addGripperMessage(message, type = 'info', isResponse = false) {
            const console = document.getElementById('gripperConsole');
            const timestamp = new Date().toLocaleTimeString();
            const messageDiv = document.createElement('div');
            messageDiv.className = 'gripper-log-entry';
            
            let className = 'text-info';
            let prefix = '→';
            
            if (isResponse) {
                prefix = '←';
                className = 'text-success';
            }
            
            switch(type) {
                case 'command': className = 'text-primary'; break;
                case 'response': className = 'text-success'; break;
                case 'error': className = 'text-danger'; break;
                case 'warning': className = 'text-warning'; break;
                case 'raw': 
                    className = 'text-secondary'; 
                    prefix = '🔧';
                    break;
                case 'raw_response': 
                    className = 'text-info'; 
                    prefix = '📡';
                    break;
            }
            
            messageDiv.innerHTML = `<span class="text-muted">[${timestamp}]</span> <span class="text-secondary">${prefix}</span> <span class="${className}">${message}</span>`;
            console.appendChild(messageDiv);
            console.scrollTop = console.scrollHeight;
            
            // Mantener solo los últimos 50 mensajes
            while (console.children.length > 50) {
                console.removeChild(console.firstChild);
            }
        }

        // Limpiar consola del gripper
        function clearGripperConsole() {
            document.getElementById('gripperConsole').innerHTML = 
                '<span class="text-info">🔍 Monitor limpiado - Todas las respuestas del gripper aparecerán aquí en tiempo real</span>';
        }

        // ==================== FIN DE FUNCIONES MEJORADAS ====================

        // Función para cambiar tema - restaurada y mejorada

        // Enviar comando específico del gripper - MONITOR CONTINUO SIN ESPERAR RESPUESTA
        function sendGripperCmd(command) {
            addGripperMessage(command, 'command');
            
            fetch('/api/gripper/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    command: command,
                    stream_response: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Solo log interno, no mensaje visible al usuario
                    addLogMessage(`Comando enviado: ${command}`, 'action');
                } else {
                    // Solo mostrar errores del servidor, no de comunicación
                    addLogMessage(`Error del servidor: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                // Error silencioso - el monitor sigue funcionando
                addLogMessage(`Comando enviado (sin confirmación): ${command}`, 'info');
            });
        }

        // Control básico del gripper
        function sendGripperBasic() {
            const force = parseFloat(document.getElementById('gripperForce').value);
            const distance = parseFloat(document.getElementById('gripperDistance').value);

            fetch('/api/gripper/control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    force: force,
                    distance: distance
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLogMessage(`Control básico: Fuerza=${force}N, Distancia=${distance}mm`, 'action');
                    addGripperMessage(`Control básico aplicado: F=${force}N, D=${distance}mm`, 'response', true);
                } else {
                    addLogMessage(`Error en control básico: ${data.error}`, 'error');
                    addGripperMessage(`Error: ${data.error}`, 'error', true);
                }
            });
        }

        function homeGripper() {
            sendGripperCmd('MOVE GRIP HOME');
        }

        function openGripper() {
            document.getElementById('gripperDistance').value = 100;
            document.getElementById('distanceValue').textContent = '100.0';
            sendGripperCmd('MOVE GRIP DIST 100.0');
        }

        function closeGripper() {
            document.getElementById('gripperDistance').value = 0;
            document.getElementById('distanceValue').textContent = '0.0';
            sendGripperCmd('MOVE GRIP DIST 0.0');
        }

        // Funciones para comandos específicos con parámetros
        function moveSteps() {
            const steps = document.getElementById('stepInput').value;
            if (!steps) {
                addGripperMessage('Error: Especifica número de pasos', 'error', true);
                return;
            }
            sendGripperCmd(`MOVE GRIP STEPS ${steps}`);
        }

        function moveDist() {
            const dist = document.getElementById('distInput').value;
            if (!dist) {
                addGripperMessage('Error: Especifica distancia en mm', 'error', true);
                return;
            }
            sendGripperCmd(`MOVE GRIP DIST ${dist}`);
        }

        function setTargetForce() {
            const force = document.getElementById('forceInput').value;
            if (!force) {
                addGripperMessage('Error: Especifica fuerza en N', 'error', true);
                return;
            }
            sendGripperCmd(`MOVE GRIP TFORCE ${force}`);
        }

        function setMotorMode() {
            const mode = document.getElementById('motorModeSelect').value;
            if (mode === '') return;
            
            const modeNames = {'0': 'Normal', '1': 'High Speed', '2': 'Precision'};
            sendGripperCmd(`CONFIG SET MOTORMODE ${mode}`);
            addGripperMessage(`Configurando modo: ${modeNames[mode]}`, 'info');
        }

        // Comando manual con historial
        function sendManualCommand() {
            const commandInput = document.getElementById('manualCommand');
            const command = commandInput.value.trim();
            
            if (!command) {
                addGripperMessage('Error: Comando vacío', 'error', true);
                return;
            }

            // Agregar al historial
            if (commandHistory.length === 0 || commandHistory[commandHistory.length - 1] !== command) {
                commandHistory.push(command);
                // Mantener solo los últimos 20 comandos
                if (commandHistory.length > 20) {
                    commandHistory.shift();
                }
                updateCommandHistory();
            }

            // Limpiar input
            commandInput.value = '';
            historyIndex = -1;

            // Enviar comando
            sendGripperCmd(command);
        }

        // Nueva función para enviar comando completamente RAW
        function sendRawCommand() {
            const commandInput = document.getElementById('manualCommand');
            const command = commandInput.value.trim();
            
            if (!command) {
                addGripperMessage('Error: Comando vacío', 'error', true);
                return;
            }

            // Agregar al historial
            if (commandHistory.length === 0 || commandHistory[commandHistory.length - 1] !== command) {
                commandHistory.push(command);
                // Mantener solo los últimos 20 comandos
                if (commandHistory.length > 20) {
                    commandHistory.shift();
                }
                updateCommandHistory();
            }

            // Limpiar input
            commandInput.value = '';
            historyIndex = -1;

            // Mostrar en consola que es comando RAW
            addGripperMessage(`RAW SOCKET: ${command}`, 'raw');
            
            // Enviar comando RAW usando el nuevo endpoint
            fetch('/api/gripper/command/raw', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ command: command })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Para comandos RAW, mostrar respuesta directamente
                    if (data.response) {
                        // Intentar parsear como JSON para respuestas estructuradas
                        try {
                            const jsonResponse = JSON.parse(data.response);
                            addGripperMessage(JSON.stringify(jsonResponse, null, 2), 'raw_response', true);
                        } catch (e) {
                            // Si no es JSON, mostrar como texto plano
                            addGripperMessage(data.response, 'raw_response', true);
                        }
                    }
                } else {
                    addGripperMessage(`Error RAW: ${data.error}`, 'error', true);
                }
                
                addLogMessage(`Comando RAW: ${command}`, 'action');
            })
            .catch(error => {
                addGripperMessage(`Error conexión RAW: ${error}`, 'error', true);
                addLogMessage(`Error comando RAW: ${error}`, 'error');
            });
        }

        function handleCommandKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                if (event.ctrlKey) {
                    // Ctrl+Enter = Comando RAW
                    sendRawCommand();
                } else {
                    // Enter simple = Comando normal
                    sendManualCommand();
                }
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                navigateHistory(-1);
            } else if (event.key === 'ArrowDown') {
                event.preventDefault();
                navigateHistory(1);
            }
        }

        function navigateHistory(direction) {
            if (commandHistory.length === 0) return;
            
            historyIndex += direction;
            
            if (historyIndex < -1) {
                historyIndex = -1;
            } else if (historyIndex >= commandHistory.length) {
                historyIndex = commandHistory.length - 1;
            }
            
            const commandInput = document.getElementById('manualCommand');
            
            if (historyIndex === -1) {
                commandInput.value = '';
            } else {
                commandInput.value = commandHistory[historyIndex];
            }
        }

        function updateCommandHistory() {
            const historyDiv = document.getElementById('commandHistory');
            historyDiv.innerHTML = '';
            
            // Mostrar últimos 3 comandos
            const recentCommands = commandHistory.slice(-3).reverse();
            
            recentCommands.forEach((cmd, index) => {
                const cmdSpan = document.createElement('span');
                cmdSpan.className = 'badge bg-secondary me-1 mb-1 cursor-pointer';
                cmdSpan.style.cursor = 'pointer';
                cmdSpan.textContent = cmd.length > 20 ? cmd.substring(0, 20) + '...' : cmd;
                cmdSpan.title = cmd;
                
                cmdSpan.onclick = function() {
                    document.getElementById('manualCommand').value = cmd;
                    document.getElementById('manualCommand').focus();
                };
                
                historyDiv.appendChild(cmdSpan);
            });
            
            // Guardar historial en localStorage
            try {
                localStorage.setItem('gripperCommandHistory', JSON.stringify(commandHistory));
            } catch (e) {
                console.warn('Error guardando historial de comandos:', e);
            }
        }

        // Función para cambiar tema - restaurada y mejorada

        // Función auxiliar para mostrar ayuda de comandos
        function showCommandHelp() {
            const helpText = `
Comandos disponibles para uSENSEGRIP:

HELP - Mostrar ayuda del dispositivo
CONFIG STALL STINFO - Toggle telemetría StallGuard
CONFIG HOMING ONBOOT - Toggle homing automático
CONFIG SET MOTORMODE <0|1|2> - Modo motor (Normal/HS/Precision)
CONFIG SAVE - Guardar configuración

MOVE GRIP HOME - Ejecutar homing completo
MOVE GRIP STEPS <int> - Mover pasos relativos
MOVE GRIP DIST <float> - Mover a distancia absoluta (mm)
MOVE GRIP TFORCE <float> - Establecer fuerza objetivo (N)

GET GRIP uSTEP - Configuración micropasos
GET GRIP STpos - Posición stepper (pasos)
GET GRIP MMpos - Posición en mm
GET GRIP ForceNf - Fuerza actual (Newtons)
GET GRIP ForceGf - Fuerza actual (gramos-fuerza)
GET GRIP DISTobj - Distancia ToF al objeto (mm)

DO FORCE CAL - Calibración interactiva de fuerza
DO GRIP REBOOT - Reiniciar microcontrolador

Ejemplos:
MOVE GRIP DIST 25.5
MOVE GRIP STEPS 100
CONFIG SET MOTORMODE 1
            `;
            
            addGripperMessage(helpText, 'info');
        }

        // Webcam functions
        function startWebcam() {
            if (!isConnected) {
                addSystemMessage('No hay conexión con el servidor', 'error');
                addLogMessage('🔴 No hay conexión con el servidor para webcam', 'error');
                return;
            }
            
            socket.emit('start_webcam', function(response) {
                if (response.success) {
                    addSystemMessage('Webcam iniciada', 'success');
                    addLogMessage('� Webcam iniciada', 'success');
                } else {
                    addSystemMessage('Error al iniciar webcam: ' + response.error, 'error');
                    addLogMessage('🔴 Error al iniciar webcam: ' + response.error, 'error');
                }
            });
        }

        function stopWebcam() {
            if (!isConnected) {
                addSystemMessage('No hay conexión con el servidor', 'error');
                addLogMessage('🔴 No hay conexión con el servidor para webcam', 'error');
                return;
            }
            
            socket.emit('stop_webcam', function(response) {
                if (response.success) {
                    addSystemMessage('Webcam detenida', 'success');
                    addLogMessage('📹 Webcam detenida', 'success');
                } else {
                    addSystemMessage('Error al detener webcam: ' + response.error, 'error');
                    addLogMessage('🔴 Error al detener webcam: ' + response.error, 'error');
                }
            });
        }

        function captureImage() {
            if (!isConnected) {
                addSystemMessage('No hay conexión con el servidor', 'error');
                addLogMessage('🔴 No hay conexión con el servidor para captura', 'error');
                return;
            }
            
            socket.emit('capture_image', function(response) {
                if (response.success) {
                    addSystemMessage('Imagen capturada: ' + response.filename, 'success');
                    addLogMessage('📸 Imagen capturada: ' + response.filename, 'success');
                } else {
                    addSystemMessage('Error al capturar imagen: ' + response.error, 'error');
                    addLogMessage('🔴 Error al capturar imagen: ' + response.error, 'error');
                }
            });
        }

        // Función para cambiar tema - mejorada
        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const themeButton = document.getElementById('themeToggle');
            
            if (isDarkTheme) {
                body.setAttribute('data-theme', 'dark');
                themeIcon.className = 'bi bi-sun-fill';
                themeButton.setAttribute('title', 'Cambiar a tema claro');
                localStorage.setItem('theme', 'dark');
                addLogMessage('🌙 Tema oscuro activado', 'info');
            } else {
                body.removeAttribute('data-theme');
                themeIcon.className = 'bi bi-moon-fill';
                themeButton.setAttribute('title', 'Cambiar a tema oscuro');
                localStorage.setItem('theme', 'light');
                addLogMessage('☀️ Tema claro activado', 'info');
            }
        }

        // Inicializar tema guardado
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                isDarkTheme = false; // Será invertido en toggleTheme
                toggleTheme();
            }
        }

        // Función para agregar mensajes al log
        function addLogMessage(message, type = 'info') {
            const console = document.getElementById('consoleLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            let className = 'log-info';
            let icon = '🔵';
            
            switch(type) {
                case 'action': 
                    className = 'log-action'; 
                    icon = '⚡';
                    break;
                case 'warning': 
                    className = 'log-warning'; 
                    icon = '⚠️';
                    break;
                case 'error': 
                    className = 'log-error'; 
                    icon = '🔴';
                    break;
                case 'success':
                    className = 'log-action';
                    icon = '✅';
                    break;
            }
            
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span> 
                <span style="margin-right: 8px;">${icon}</span>
                <span class="${className}">${message}</span>
            `;
            console.appendChild(logEntry);
            console.scrollTop = console.scrollHeight;
            
            // Mantener solo los últimos 100 mensajes
            while (console.children.length > 100) {
                console.removeChild(console.firstChild);
            }
        }

        // Limpiar log
        function clearLog() {
            document.getElementById('consoleLog').innerHTML = '';
            addLogMessage('🧹 Consola limpiada', 'info');
        }

        function updateSliderValues() {
            document.getElementById('gripperForce').addEventListener('input', function() {
                document.getElementById('forceValue').textContent = this.value;
                addLogMessage(`🔧 Fuerza de gripper ajustada a ${this.value}N`, 'action');
            });

            document.getElementById('gripperDistance').addEventListener('input', function() {
                document.getElementById('distanceValue').textContent = this.value;
                addLogMessage(`📐 Distancia de gripper ajustada a ${this.value}mm`, 'action');
            });
        }

        // Nuevas funciones para los controles del gripper
        function sendGripperBasic() {
            const force = document.getElementById('gripperForce').value;
            const distance = document.getElementById('gripperDistance').value;
            addLogMessage(`🔧 Enviando configuración básica - Fuerza: ${force}N, Distancia: ${distance}mm`, 'action');
            // Aquí iría la lógica para enviar los comandos básicos
        }

        function homeGripper() {
            sendGripperCmd('MOVE GRIP HOME');
        }

        function moveSteps() {
            const steps = document.getElementById('stepInput').value;
            if (steps) {
                sendGripperCmd(`MOVE GRIP STEPS ${steps}`);
            } else {
                addLogMessage('⚠️ Ingrese número de pasos', 'warning');
            }
        }

        function moveDist() {
            const dist = document.getElementById('distInput').value;
            if (dist) {
                sendGripperCmd(`MOVE GRIP DIST ${dist}`);
            } else {
                addLogMessage('⚠️ Ingrese distancia en mm', 'warning');
            }
        }

        function setTargetForce() {
            const force = document.getElementById('forceInput').value;
            if (force) {
                sendGripperCmd(`SET GRIP FORCE ${force}`);
            } else {
                addLogMessage('⚠️ Ingrese fuerza objetivo en N', 'warning');
            }
        }

        function clearGripperConsole() {
            document.getElementById('gripperConsole').innerHTML = '';
            addLogMessage('🧹 Consola del gripper limpiada', 'info');
        }

        // Función goHome para el botón Home del robot
        function goHome() {
            addLogMessage('🏠 Enviando robot a posición Home', 'action');
            
            // Coordenadas de home (puedes ajustar estos valores)
            const homePosition = {
                x: 300,
                y: -200, 
                z: 500,
                rx: 0,
                ry: 0,
                rz: 0
            };

            // Actualizar campos de coordenadas
            document.getElementById('coordX').value = homePosition.x;
            document.getElementById('coordY').value = homePosition.y;
            document.getElementById('coordZ').value = homePosition.z;
            document.getElementById('coordRX').value = homePosition.rx;
            document.getElementById('coordRY').value = homePosition.ry;
            document.getElementById('coordRZ').value = homePosition.rz;

            // Ejecutar movimiento
            moveToCoordinates();
        }

        function capturePhoto() {
            if (!isConnected) {
                addLogMessage('🔴 No hay conexión con el servidor para captura', 'error');
                return;
            }
            
            socket.emit('capture_image', function(response) {
                if (response.success) {
                    addLogMessage('📸 Imagen capturada: ' + response.filename, 'success');
                } else {
                    addLogMessage('🔴 Error al capturar imagen: ' + response.error, 'error');
                }
            });
        }

        // Mover robot a coordenadas
        function moveToCoordinates() {
            const coords = {
                x: document.getElementById('coordX').value,
                y: document.getElementById('coordY').value,
                z: document.getElementById('coordZ').value,
                rx: document.getElementById('coordRX').value,
                ry: document.getElementById('coordRY').value,
                rz: document.getElementById('coordRZ').value
            };

            addLogMessage(`🎯 Comando de movimiento enviado: X=${coords.x}, Y=${coords.y}, Z=${coords.z}`, 'action');
            
            // Simular movimiento
            document.getElementById('robotStatus').textContent = 'En Movimiento';
            document.getElementById('robotStatus').className = 'status-moving';
            addLogMessage('🔄 Robot iniciando movimiento...', 'info');

            setTimeout(() => {
                currentPosition = coords;
                updateCurrentPosition();
                document.getElementById('robotStatus').textContent = 'En Espera';
                document.getElementById('robotStatus').className = 'status-connected';
                addLogMessage('✅ Movimiento completado exitosamente', 'success');
            }, 2000);
        }

        // Listar posiciones guardadas
        function listPositions() {
            const positions = Object.keys(savedPositions);
            addLogMessage(`Posiciones guardadas: ${positions.length > 0 ? positions.join(', ') : 'Ninguna'}`, 'info');
            if (positions.length > 0) {
                alert('Posiciones guardadas: ' + positions.join(', '));
            } else {
                alert('No hay posiciones guardadas');
            }
        }

        // Guardar posición actual
        function savePosition() {
            const name = document.getElementById('positionName').value;
            if (name) {
                savedPositions[name] = { ...currentPosition };
                addLogMessage(`Posición "${name}" guardada exitosamente`, 'action');
                alert('Posición "' + name + '" guardada exitosamente');
                document.getElementById('positionName').value = '';
            } else {
                addLogMessage('Error: Nombre de posición requerido', 'error');
                alert('Por favor, ingrese un nombre para la posición');
            }
        }

        // Cargar posición guardada
        function loadPosition() {
            const name = document.getElementById('positionName').value;
            if (name && savedPositions[name]) {
                const pos = savedPositions[name];
                document.getElementById('coordX').value = pos.x;
                document.getElementById('coordY').value = pos.y;
                document.getElementById('coordZ').value = pos.z;
                document.getElementById('coordRX').value = pos.rx;
                document.getElementById('coordRY').value = pos.ry;
                document.getElementById('coordRZ').value = pos.rz;
                addLogMessage(`Posición "${name}" cargada en campos de entrada`, 'action');
                alert('Posición "' + name + '" cargada en los campos');
            } else {
                addLogMessage(`Error: Posición "${name}" no encontrada`, 'error');
                alert('Posición no encontrada: ' + name);
            }
        }

        // Ejecutar programa preestablecido
        function runProgram(programNumber) {
            const programs = {
                1: 'Rutina de Calibración',
                2: 'Ciclo de Prueba',
                3: 'Posición Inicial',
                4: 'Rutina de Seguridad'
            };

            const routineName = programs[programNumber];
            
            fetch(`/api/routines/${programNumber}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLogMessage(`Rutina "${routineName}" ejecutada exitosamente`, 'action');
                } else {
                    addLogMessage(`Error ejecutando rutina "${routineName}": ${data.error}`, 'error');
                }
            });
        }

        // Toggle modo de control
        function toggleControlMode() {
            const toggle = document.getElementById('controlToggle');
            const modeText = document.getElementById('controlMode');
            
            isXboxMode = !isXboxMode;
            
            const mode = isXboxMode ? 'xbox' : 'coordinates';
            
            fetch('/api/control-mode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ mode: mode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (isXboxMode) {
                        toggle.classList.add('active');
                        modeText.textContent = 'Xbox Controller';
                    } else {
                        toggle.classList.remove('active');
                        modeText.textContent = 'Coordenadas';
                    }
                    addLogMessage(`Modo de control cambiado a: ${modeText.textContent}`, 'action');
                }
            });
        }

        // Actualizar posición actual en pantalla
        function updateCurrentPosition() {
            document.getElementById('currentX').textContent = currentPosition.x || '0.0';
            document.getElementById('currentY').textContent = currentPosition.y || '0.0';
            document.getElementById('currentZ').textContent = currentPosition.z || '0.0';
            document.getElementById('currentRX').textContent = currentPosition.rx || '0.0';
            document.getElementById('currentRY').textContent = currentPosition.ry || '0.0';
            document.getElementById('currentRZ').textContent = currentPosition.rz || '0.0';
        }

        // ==================== FUNCIONES DEL GRIPPER uSENSE - RESTAURADAS ====================

        // Comando manual con historial
        function sendManualCommand() {
            const commandInput = document.getElementById('manualCommand');
            const command = commandInput.value.trim();
            
            if (!command) {
                addGripperMessage('Error: Comando vacío', 'error', true);
                return;
            }

            // Agregar al historial
            if (commandHistory.length === 0 || commandHistory[commandHistory.length - 1] !== command) {
                commandHistory.push(command);
                // Mantener solo los últimos 20 comandos
                if (commandHistory.length > 20) {
                    commandHistory.shift();
                }
                updateCommandHistory();
            }

            // Limpiar input
            commandInput.value = '';
            historyIndex = -1;

            // Enviar comando
            sendGripperCmd(command);
        }

        // Nueva función para enviar comando completamente RAW
        function sendRawCommand() {
            const commandInput = document.getElementById('manualCommand');
            const command = commandInput.value.trim();
            
            if (!command) {
                addGripperMessage('Error: Comando vacío', 'error', true);
                return;
            }

            // Agregar al historial
            if (commandHistory.length === 0 || commandHistory[commandHistory.length - 1] !== command) {
                commandHistory.push(command);
                // Mantener solo los últimos 20 comandos
                if (commandHistory.length > 20) {
                    commandHistory.shift();
                }
                updateCommandHistory();
            }

            // Limpiar input
            commandInput.value = '';
            historyIndex = -1;

            // Mostrar en consola que es comando RAW
            addGripperMessage(`RAW SOCKET: ${command}`, 'raw');
            
            // Enviar comando RAW usando el nuevo endpoint
            fetch('/api/gripper/command/raw', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ command: command })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Para comandos RAW, mostrar respuesta directamente
                    if (data.response) {
                        // Intentar parsear como JSON para respuestas estructuradas
                        try {
                            const jsonResponse = JSON.parse(data.response);
                            addGripperMessage(JSON.stringify(jsonResponse, null, 2), 'raw_response', true);
                        } catch (e) {
                            // Si no es JSON, mostrar como texto plano
                            addGripperMessage(data.response, 'raw_response', true);
                        }
                    }
                } else {
                    addGripperMessage(`Error RAW: ${data.error}`, 'error', true);
                }
                
                addLogMessage(`Comando RAW: ${command}`, 'action');
            })
            .catch(error => {
                addGripperMessage(`Error conexión RAW: ${error}`, 'error', true);
                addLogMessage(`Error comando RAW: ${error}`, 'error');
            });
        }

        function handleCommandKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                if (event.ctrlKey) {
                    // Ctrl+Enter = Comando RAW
                    sendRawCommand();
                } else {
                    // Enter simple = Comando normal
                    sendManualCommand();
                }
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                navigateHistory(-1);
            } else if (event.key === 'ArrowDown') {
                event.preventDefault();
                navigateHistory(1);
            }
        }

        function navigateHistory(direction) {
            if (commandHistory.length === 0) return;
            
            historyIndex += direction;
            
            if (historyIndex < -1) {
                historyIndex = -1;
            } else if (historyIndex >= commandHistory.length) {
                historyIndex = commandHistory.length - 1;
            }
            
            const commandInput = document.getElementById('manualCommand');
            
            if (historyIndex === -1) {
                commandInput.value = '';
            } else {
                commandInput.value = commandHistory[historyIndex];
            }
        }

        function updateCommandHistory() {
            const historyDiv = document.getElementById('commandHistory');
            if (!historyDiv) return; // Prevenir errores si el elemento no existe
            
            historyDiv.innerHTML = '';
            
            // Mostrar últimos 3 comandos
            const recentCommands = commandHistory.slice(-3).reverse();
            
            recentCommands.forEach((cmd, index) => {
                const cmdSpan = document.createElement('span');
                cmdSpan.className = 'badge bg-secondary me-1 mb-1 cursor-pointer';
                cmdSpan.style.cursor = 'pointer';
                cmdSpan.textContent = cmd.length > 20 ? cmd.substring(0, 20) + '...' : cmd;
                cmdSpan.title = cmd;
                
                cmdSpan.onclick = function() {
                    const input = document.getElementById('manualCommand');
                    if (input) {
                        input.value = cmd;
                        input.focus();
                    }
                };
                
                historyDiv.appendChild(cmdSpan);
            });
            
            // Guardar historial en localStorage
            try {
                localStorage.setItem('gripperCommandHistory', JSON.stringify(commandHistory));
            } catch (e) {
                console.warn('Error guardando historial de comandos:', e);
            }
        }

        // Función mejorada para agregar mensajes del gripper - SIN TIMEOUTS
        function addGripperMessage(message, type = 'info', isResponse = false) {
            const console = document.getElementById('gripperConsole');
            if (!console) return; // Prevenir errores si el elemento no existe
            
            const timestamp = new Date().toLocaleTimeString();
            const messageDiv = document.createElement('div');
            messageDiv.className = 'gripper-log-entry';
            
            let className = 'text-info';
            let prefix = '→';
            
            if (isResponse) {
                prefix = '←';
                className = 'text-success';
            }
            
            switch(type) {
                case 'command': 
                    className = 'text-primary'; 
                    prefix = '📤';
                    break;
                case 'response': 
                    className = 'text-success'; 
                    prefix = '📥';
                    break;
                case 'error': 
                    className = 'text-danger'; 
                    prefix = '❌';
                    break;
                case 'warning': 
                    className = 'text-warning'; 
                    prefix = '⚠️';
                    break;
                case 'raw': 
                    className = 'text-secondary'; 
                    prefix = '🔧';
                    break;
                case 'raw_response': 
                    className = 'text-info'; 
                    prefix = '📡';
                    break;
                case 'stream':
                    className = 'text-cyan';
                    prefix = '🔄';
                    break;
                case 'info':
                    className = 'text-info';
                    prefix = 'ℹ️';
                    break;
            }
            
            // Formatear mensaje con mejor legibilidad
            let formattedMessage = message;
            
            // Detectar si es una línea de ayuda o información estructurada
            if (message.includes('CONFIG') || message.includes('MOVE') || message.includes('GET') || message.includes('DO')) {
                formattedMessage = `<code style="background: rgba(0,0,0,0.1); padding: 2px 4px; border-radius: 3px;">${message}</code>`;
            } else if (message.includes(':') && (message.includes('mm') || message.includes('N') || message.includes('steps'))) {
                formattedMessage = `<strong>${message}</strong>`;
            }
            
            messageDiv.innerHTML = `<span class="text-muted">[${timestamp}]</span> <span class="text-secondary">${prefix}</span> <span class="${className}">${formattedMessage}</span>`;
            console.appendChild(messageDiv);
            
            // Auto-scroll sin interrumpir al usuario si está revisando mensajes anteriores
            const isScrolledToBottom = console.scrollTop + console.clientHeight >= console.scrollHeight - 10;
            if (isScrolledToBottom) {
                console.scrollTop = console.scrollHeight;
            }
            
            // Mantener solo los últimos 200 mensajes (aumentado para HELP y comandos largos)
            while (console.children.length > 200) {
                console.removeChild(console.firstChild);
            }
        }

        function updateGripperStatus(data) {
            // Actualizar badge de conexión
            const badge = document.getElementById('gripperConnectionBadge');
            if (badge) {
                if (data.connected) {
                    badge.textContent = `Conectado (${data.port || 'N/A'})`;
                    badge.className = 'badge bg-success me-2';
                } else {
                    badge.textContent = 'Desconectado';
                    badge.className = 'badge bg-danger me-2';
                }
            }
        }

        // Detección de gamepad (Xbox Controller)
        window.addEventListener("gamepadconnected", function(e) {
            let gamepadIndex = e.gamepad.index;
            addLogMessage(`Xbox Controller conectado: ${e.gamepad.id}`, 'action');
            if (isXboxMode) {
                const xboxStatus = document.getElementById('xboxStatus');
                if (xboxStatus) {
                    xboxStatus.textContent = 'Conectado';
                    xboxStatus.className = 'status-connected';
                }
            }
        });

        window.addEventListener("gamepaddisconnected", function(e) {
            addLogMessage(`Xbox Controller desconectado: ${e.gamepad.id}`, 'warning');
            let gamepadIndex = null;
            const xboxStatus = document.getElementById('xboxStatus');
            if (xboxStatus) {
                xboxStatus.textContent = 'Desconectado';
                xboxStatus.className = 'status-disconnected';
            }
        });
    </script>
</body>
</html>